<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Data Visualizer (Enhanced)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.min.js"></script>


    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Inter', sans-serif;
            color: #fff;
        }

        #webgl-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            cursor: grab;
        }
        #webgl-container.grabbing {
            cursor: grabbing;
        }
        #webgl-container.hovering {
            cursor: pointer;
        }


        #data-overlay {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            color: #fff;
            padding: 12px 18px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            z-index: 100;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(0, 200, 255, 0.3);
            border: 1px solid rgba(0, 200, 255, 0.2);
            transition: opacity 0.5s ease-in-out;
        }

        #data-overlay p {
            margin: 4px 0;
            line-height: 1.4;
        }

        #data-overlay strong {
            color: #8affff;
        }

        #data-overlay span {
            color: #00ffff;
        }

        #loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 20px;
            z-index: 200;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.4);
            border: 1px solid rgba(255, 255, 0, 0.3);
            text-align: center;
        }

        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        #loading-indicator p {
            animation: pulse 1.5s infinite ease-in-out;
            margin: 0;
        }

        #error-message {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-family: sans-serif;
            font-size: 14px;
            z-index: 200;
            display: none;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .interactive-button {
            background-image: linear-gradient(to right, #4CAF50, #28a745);
            border: none;
            color: white;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin-top: 5px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .interactive-button:hover {
            background-image: linear-gradient(to right, #45a049, #218838);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }

        .interactive-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .interactive-button:disabled {
            background-color: #6c757d;
            background-image: none;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        #intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
            opacity: 1;
            transition: opacity 1.5s ease-out;
            backdrop-filter: blur(8px);
        }

        #intro-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #intro-screen h1 {
            font-size: 3.5em;
            margin-bottom: 20px;
            color: #00ffff;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
            animation: fadeInScale 2s ease-out;
        }

        #intro-screen p {
            font-size: 1.3em;
            max-width: 700px;
            line-height: 1.5;
            margin-bottom: 20px;
            padding: 0 30px;
            font-weight: 300;
        }

        #intro-screen ul {
            display: none;
        }

        #intro-screen button {
            background-image: linear-gradient(to right, #6a0dad, #8a2be2);
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
            animation: fadeIn 3s ease-out;
        }

        #intro-screen button:hover {
            background-image: linear-gradient(to right, #8a2be2, #6a0dad);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.4);
            transform: translateY(-3px);
        }

        #intro-screen button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        #object-info-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.6);
            border: 1px solid rgba(0, 255, 255, 0.3);
            max-width: 400px;
            text-align: left;
            z-index: 500;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #object-info-modal.show {
            opacity: 1;
        }

        #object-info-modal h3 {
            margin-top: 0;
            color: #00ffff;
            border-bottom: 1px solid rgba(0, 255, 255, 0.3);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        #object-info-modal p {
            margin: 5px 0;
            font-size: 0.95em;
        }

        #object-info-modal .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
        }

        #object-info-modal .close-button:hover {
            color: #00ffff;
        }

        #modal-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            gap: 10px;
        }

        #modal-buttons button {
            flex: 1;
            background-image: linear-gradient(to right, #007bff, #0056b3);
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #modal-buttons button:hover {
            background-image: linear-gradient(to right, #0056b3, #004085);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #modal-buttons button:disabled {
            background-image: none;
            background-color: #6c757d;
            cursor: not-allowed;
        }

        #chat-assistant-container {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 350px;
            height: 500px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(135, 206, 250, 0.5);
            border: 1px solid rgba(135, 206, 250, 0.3);
            z-index: 100;
            display: flex;
            flex-direction: column;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        #chat-header {
            background-color: rgba(40, 40, 60, 0.8);
            padding: 10px 15px;
            border-bottom: 1px solid rgba(135, 206, 250, 0.2);
            color: #aaddff;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chat-minimize-button {
            background: none;
            border: none;
            color: #aaddff;
            font-size: 1.2em;
            cursor: pointer;
        }

        #chat-window {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-message {
            background-color: rgba(50, 50, 70, 0.8);
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 0.9em;
        }

        .chat-message.user {
            align-self: flex-end;
            background-color: rgba(0, 120, 180, 0.8);
            border-bottom-right-radius: 2px;
        }

        .chat-message.ai {
            align-self: flex-start;
            background-color: rgba(80, 80, 100, 0.8);
            border-bottom-left-radius: 2px;
        }

        #chat-input-container {
            padding: 10px 15px;
            border-top: 1px solid rgba(135, 206, 250, 0.2);
            display: flex;
            gap: 10px;
        }

        #chat-input {
            flex-grow: 1;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #666;
            background-color: rgba(30, 30, 40, 0.9);
            color: white;
            font-size: 0.9em;
        }

        #chat-send-button {
            background-image: linear-gradient(to right, #007bff, #0056b3);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #chat-send-button:hover {
            background-image: linear-gradient(to right, #0056b3, #004085);
        }
        #chat-send-button:disabled {
            background-color: #6c757d;
            background-image: none;
            cursor: not-allowed;
        }
        #ai-typing-indicator {
            font-style: italic;
            color: #aaddff;
            font-size: 0.8em;
            align-self: flex-start;
            margin-left: 10px;
            display: none;
        }

        #chat-assistant-container.minimized {
            height: 40px;
            width: 250px;
            overflow: hidden;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        #chat-assistant-container.minimized #chat-window,
        #chat-assistant-container.minimized #chat-input-container {
            display: none;
        }

        #control-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 12px 18px;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            z-index: 100;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.3);
            border: 1px solid rgba(255, 255, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #control-panel button {
            background-image: linear-gradient(to right, #6c757d, #495057);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 13px;
        }
        #control-panel button:hover {
            background-image: linear-gradient(to right, #495057, #343a40);
        }
    </style>
</head>
<body>
    <div id="intro-screen">
        <h1>Cosmic Data Visualizer</h1>
        <p>
            Welcome to your interactive window into Earth's orbit! This application brings real-time space data to life in a stunning 3D environment.
        </p>
        <p>
            Explore our vibrant Earth, track the International Space Station, and discover a fleet of detailed satellites.
            Click on any object to reveal its information and find new ways to interact. For deeper insights, chat with our AI Assistant!
        </p>
        <button id="start-button" class="interactive-button">Enter the Cosmos</button>
    </div>

    <div id="webgl-container"></div>

    <div id="data-overlay">
        <p><strong>APOD:</strong> <span id="apod-title">Fetching...</span></p>
        <p><strong>ISS Location:</strong> <span id="iss-coords">Fetching...</span></p>
        <p><strong>Astronauts:</strong> <span id="astronaut-count">Fetching...</span></p>
    </div>

    <div id="chat-assistant-container">
        <div id="chat-header">
            Cosmic AI Assistant
            <button id="chat-minimize-button">_</button>
        </div>
        <div id="chat-window">
            <div class="chat-message ai">Hello! Ask me anything about space and the cosmos.</div>
        </div>
        <div id="ai-typing-indicator">AI is typing...</div>
        <div id="chat-input-container">
            <input type="text" id="chat-input" placeholder="Ask about space...">
            <button id="chat-send-button">Send</button>
        </div>
    </div>

    <div id="control-panel">
        <button id="toggle-rotate-button" class="interactive-button">Toggle Auto-Rotate</button>
        <button id="recenter-camera-button" class="interactive-button">Recenter Camera</button>
        <button id="toggle-satellites-button" class="interactive-button">Hide Satellites</button>
        <button id="focus-iss-button" class="interactive-button">Focus ISS</button>
        <button id="toggle-asteroid-belt-button" class="interactive-button">Hide Asteroid Belt</button>
        <button id="toggle-orbit-paths-button" class="interactive-button">Hide Orbit Paths</button>
    </div>

    <div id="loading-indicator">
        <p>Loading Cosmic Data...</p>
        <p>Please wait for the universe to align!</p>
    </div>

    <div id="error-message">
        <p>API Error: Failed to fetch some data. Displaying default animation.</p>
        <p>Check console for details.</p>
    </div>

    <div id="object-info-modal">
        <button class="close-button">&times;</button>
        <h3 id="modal-title"></h3>
        <p id="modal-content"></p>
        <div id="modal-buttons">
            <button id="modal-focus-button">Focus Camera</button>
            <button id="modal-ask-ai-button">Ask AI Assistant</button>
        </div>
    </div>

    <script>
        const NASA_API_KEY = '3IbGcjTrcVIaaocozzHg4dqq1Nj8a2rnayRsxKEX';
        const ISS_FETCH_INTERVAL = 7000;
        const ASTRO_FETCH_INTERVAL = 35000;
        const ERROR_DISPLAY_DURATION = 8000;
        const INTRO_SCREEN_FADE_DELAY = 500;
        const NUM_GENERIC_SATELLITES = 50;
        const SATELLITE_ORBIT_MIN_ALT = 0.15;
        const SATELLITE_ORBIT_MAX_ALT = 0.5;
        const NUM_ASTEROIDS = 1000;
        const ASTEROID_BELT_MIN_RADIUS = 1.8;
        const ASTEROID_BELT_MAX_RADIUS = 2.5;

        let scene, camera, renderer, controls;
        let earth, earthAtmosphere, issMarker, stars, asteroidBelt = null;
        let issTrailGeo, issTrailMat, issTrailLine;
        let genericSatellites = [];
        let astronautMarkers = [];
        let orbitPaths = [];
        let mouse = new THREE.Vector2();
        let raycaster = new THREE.Raycaster();
        let currentlyHoveredObject = null;
        let clicked3DObject = null;

        let apodImage = null;
        let apodTitle = "Fetching Astronomy Picture...";
        let issLatitude = 0;
        let issLongitude = 0;
        let astronauts = 0;
        let astronautsNames = [];

        let isLoading = true;
        let errorMessageTimeout;

        let chatHistory = [{ role: "model", parts: [{ text: "Hello! Ask me anything about space and the cosmos. Feel free to ask about Earth, the ISS, or the satellites around it!" }] }];
        let isAITyping = false;

        const geminiApiKey = "";

        let webglContainer;
        let dataOverlay;
        let apodTitleSpan;
        let issCoordsSpan;
        let astronautCountSpan;
        let loadingIndicator;
        let errorMessageDiv;
        let introScreen;
        let startButton;
        let objectInfoModal, modalTitle, modalContent, closeModalButton;
        let modalFocusButton, modalAskAIButton;
        let chatAssistantContainer, chatHeader, chatMinimizeButton, chatWindow, chatInput, chatSendButton, aiTypingIndicator;
        let controlPanel, toggleRotateButton, recenterCameraButton, toggleSatellitesButton, focusIssButton, toggleAsteroidBeltButton, toggleOrbitPathsButton;

        window.onload = function() {
            webglContainer = document.getElementById('webgl-container');
            dataOverlay = document.getElementById('data-overlay');
            apodTitleSpan = document.getElementById('apod-title');
            issCoordsSpan = document.getElementById('iss-coords');
            astronautCountSpan = document.getElementById('astronaut-count');
            loadingIndicator = document.getElementById('loading-indicator');
            errorMessageDiv = document.getElementById('error-message');
            introScreen = document.getElementById('intro-screen');
            startButton = document.getElementById('start-button');
            objectInfoModal = document.getElementById('object-info-modal');
            modalTitle = document.getElementById('modal-title');
            modalContent = document.getElementById('modal-content');
            closeModalButton = objectInfoModal.querySelector('.close-button');
            modalFocusButton = document.getElementById('modal-focus-button');
            modalAskAIButton = document.getElementById('modal-ask-ai-button');
            chatAssistantContainer = document.getElementById('chat-assistant-container');
            chatHeader = document.getElementById('chat-header');
            chatMinimizeButton = document.getElementById('chat-minimize-button');
            chatWindow = document.getElementById('chat-window');
            chatInput = document.getElementById('chat-input');
            chatSendButton = document.getElementById('chat-send-button');
            aiTypingIndicator = document.getElementById('ai-typing-indicator');
            controlPanel = document.getElementById('control-panel');
            toggleRotateButton = document.getElementById('toggle-rotate-button');
            recenterCameraButton = document.getElementById('recenter-camera-button');
            toggleSatellitesButton = document.getElementById('toggle-satellites-button');
            focusIssButton = document.getElementById('focus-iss-button');
            toggleAsteroidBeltButton = document.getElementById('toggle-asteroid-belt-button');
            toggleOrbitPathsButton = document.getElementById('toggle-orbit-paths-button');

            startButton.addEventListener('click', hideIntroScreen);
            closeModalButton.addEventListener('click', hideObjectInfo);
            modalFocusButton.addEventListener('click', () => focusCameraOnObject(clicked3DObject));
            modalAskAIButton.addEventListener('click', () => askAIAboutObject(clicked3DObject));

            chatSendButton.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    sendChatMessage();
                }
            });
            chatMinimizeButton.addEventListener('click', toggleChatMinimize);
            toggleRotateButton.addEventListener('click', toggleAutoRotate);
            recenterCameraButton.addEventListener('click', recenterCamera);
            toggleSatellitesButton.addEventListener('click', toggleSatellitesVisibility);
            focusIssButton.addEventListener('click', () => focusCameraOnObject(issMarker));
            toggleAsteroidBeltButton.addEventListener('click', toggleAsteroidBeltVisibility);
            toggleOrbitPathsButton.addEventListener('click', toggleOrbitPathsVisibility);

            init3DScene();
            animate();

            webglContainer.addEventListener('mousemove', onDocumentMouseMove, false);
            webglContainer.addEventListener('click', onDocumentClick, false);
            webglContainer.addEventListener('mousedown', () => webglContainer.classList.add('grabbing'), false);
            webglContainer.addEventListener('mouseup', () => webglContainer.classList.remove('grabbing'), false);
            webglContainer.addEventListener('touchstart', (event) => {
                if (event.touches.length === 1) {
                    onDocumentMouseMove(event.touches[0]);
                }
            }, false);
            webglContainer.addEventListener('touchend', (event) => {
                if (event.changedTouches.length === 1) {
                    onDocumentClick(event.changedTouches[0]);
                }
            }, false);

            Promise.allSettled([
                fetchAPOD(),
                fetchISSLocation(),
                fetchPeopleInSpace()
            ]).then(() => {
                isLoading = false;
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                    if (!introScreen.classList.contains('hidden')) {
                         hideIntroScreen();
                    }
                }, INTRO_SCREEN_FADE_DELAY);

                updateChatWindow();
            });

            setInterval(fetchISSLocation, ISS_FETCH_INTERVAL);
            setInterval(fetchPeopleInSpace, ASTRO_FETCH_INTERVAL);

            window.addEventListener('resize', onWindowResize, false);
        };

        function init3DScene() {
            scene = new THREE.Scene();

            const backgroundTextureLoader = new THREE.TextureLoader();
            backgroundTextureLoader.load(
                'https://cdn.jsdelivr.net/npm/three-globe@2.27.6/example/img/night-sky.png',
                (texture) => {
                    scene.background = texture;
                },
                undefined,
                (err) => {
                    console.error('Failed to load scene background texture:', err);
                    scene.background = new THREE.Color(0x000000);
                }
            );

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 2;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            webglContainer.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.minDistance = 1.2;
            controls.maxDistance = 10;
            controls.enablePan = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.5;
            controls.target.set(0, 0, 0);

            const ambientLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffeedd, 3);
            directionalLight.position.set(5, 3, 5).normalize();
            scene.add(directionalLight);

            const earthGeometry = new THREE.SphereGeometry(1, 64, 64);
            const earthMaterial = new THREE.MeshPhongMaterial({
                map: new THREE.TextureLoader().load('https://unpkg.com/three-globe@2.27.6/example/img/earth-blue-marble.jpg'),
                specular: new THREE.Color(0x333333),
                shininess: 15,
                emissive: 0x000011
            });
            earth = new THREE.Mesh(earthGeometry, earthMaterial);
            earth.name = "Earth";
            earth.userData = { type: 'Planet', name: 'Earth', description: 'Our home planet, vibrant with life.' };
            scene.add(earth);

            const atmosphereGeometry = new THREE.SphereGeometry(1.02, 64, 64);
            const atmosphereMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    c: { type: "f", value: 0.1 },
                    p: { type: "f", value: 4.0 },
                    glowColor: { type: "c", value: new THREE.Color(0x00aaff) }
                },
                vertexShader: `
                    uniform float c;
                    uniform float p;
                    varying float intensity;
                    void main() {
                        vec3 vNormal = normalize( normalMatrix * normal );
                        vec3 vPosition = normalize( modelViewMatrix * vec4( position, 1.0 ) ).xyz;
                        intensity = pow( c - dot(vNormal, vPosition), p );
                        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
                    }
                `,
                fragmentShader: `
                    uniform vec3 glowColor;
                    varying float intensity;
                    void main() {
                        gl_FragColor = vec4( glowColor, 1.0 ) * intensity;
                    }
                `,
                side: THREE.BackSide,
                blending: THREE.AdditiveBlending,
                transparent: true
            });
            earthAtmosphere = new THREE.Mesh(atmosphereGeometry, atmosphereMaterial);
            scene.add(earthAtmosphere);


            const issBodyGeometry = new THREE.BoxGeometry(0.03, 0.03, 0.06);
            const issPanelGeometry = new THREE.BoxGeometry(0.1, 0.005, 0.04);
            const issAntennaGeometry = new THREE.CylinderGeometry(0.003, 0.003, 0.05, 8);

            const issMainMaterial = new THREE.MeshPhongMaterial({ color: 0xcccccc, emissive: 0x111111 });
            const issPanelMaterial = new THREE.MeshBasicMaterial({ color: 0x444444, side: THREE.DoubleSide });
            const issAntennaMaterial = new THREE.MeshBasicMaterial({ color: 0x888888 });

            issMarker = new THREE.Group();
            const issBody = new THREE.Mesh(issBodyGeometry, issMainMaterial);
            issMarker.add(issBody);

            const issPanel1 = new THREE.Mesh(issPanelGeometry, issPanelMaterial);
            issPanel1.position.x = -0.07;
            issBody.add(issPanel1);

            const issPanel2 = new THREE.Mesh(issPanelGeometry, issPanelMaterial);
            issPanel2.position.x = 0.07;
            issBody.add(issPanel2);

            const issAntenna = new THREE.Mesh(issAntennaGeometry, issAntennaMaterial);
            issAntenna.position.y = 0.04;
            issBody.add(issAntenna);

            issMarker.name = "ISS";
            issMarker.userData = { type: 'Satellite', id: 'ISS (International Space Station)', description: 'Humanity\'s orbiting research outpost, a collaborative project of many nations.' };
            scene.add(issMarker);


            issTrailGeo = new THREE.BufferGeometry();
            issTrailMat = new THREE.LineBasicMaterial({
                vertexColors: true,
                transparent: true,
                opacity: 0.9,
                blending: THREE.AdditiveBlending
            });
            issTrailLine = new THREE.Line(issTrailGeo, issTrailMat);
            scene.add(issTrailLine);

            createGenericSatellites();
            createStars();
            createAsteroidBelt();
            createOrbitPaths();
        };

        function animate() {
            requestAnimationFrame(animate);

            controls.update();

            if (earthAtmosphere) {
                earthAtmosphere.position.copy(earth.position);
            }

            updateISSMarker();

            genericSatellites.forEach(satelliteGroup => {
                const orbitalRadius = satelliteGroup.userData.orbitRadius;
                const orbitalSpeed = satelliteGroup.userData.orbitalSpeed;
                const initialAngle = satelliteGroup.userData.initialAngle || 0;

                const angle = (performance.now() * orbitalSpeed) + initialAngle;
                satelliteGroup.position.x = orbitalRadius * Math.cos(angle);
                satelliteGroup.position.z = orbitalRadius * Math.sin(angle);
                satelliteGroup.position.y = satelliteGroup.userData.yOffset;
                
                if (satelliteGroup.children[0]) {
                    satelliteGroup.children[0].rotation.y += 0.02;
                    satelliteGroup.children[0].rotation.x += 0.01;
                }
            });

            if (asteroidBelt) {
                asteroidBelt.rotation.y += 0.0001;
            }

            checkHoveredObjects();

            TWEEN.update();

            renderer.render(scene, camera);
        };

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };

        function convertSphericalToCartesian(lat, lon, radius) {
            const latRad = THREE.MathUtils.degToRad(lat);
            const lonRad = THREE.MathUtils.degToRad(lon);

            const x = radius * Math.cos(latRad) * Math.cos(lonRad);
            const y = radius * Math.sin(latRad);
            const z = radius * Math.cos(latRad) * Math.sin(lonRad);
            return new THREE.Vector3(x, y, z);
        };


        function updateISSMarker() {
            const earthRadius = 1;
            const issAltitudeFactor = 0.08;
            const radius = earthRadius + issAltitudeFactor;

            const issPosition = convertSphericalToCartesian(issLatitude, issLongitude, radius);
            issMarker.position.copy(issPosition);

            // Ensure issTrailPositions is initialized before pushing
            if (!issTrailPositions) {
                issTrailPositions = [];
            }
            issTrailPositions.push(issMarker.position.clone());
            if (issTrailPositions.length > MAX_TRAIL_POINTS) {
                issTrailPositions.shift();
            }

            const positions = [];
            const colors = [];
            const colorStart = new THREE.Color(0x00FFFF);
            const colorMiddle = new THREE.Color(0x8A2BE2);
            const colorEnd = new THREE.Color(0x4B0082);

            for (let i = 0; i < issTrailPositions.length; i++) {
                const p = issTrailPositions[i];
                positions.push(p.x, p.y, p.z);

                const alpha = i / (MAX_TRAIL_POINTS - 1);
                let color;
                if (alpha < 0.5) {
                    color = colorStart.clone().lerp(colorMiddle, alpha * 2);
                } else {
                    color = colorMiddle.clone().lerp(colorEnd, (alpha - 0.5) * 2);
                }
                colors.push(color.r, color.g, color.b);
            }

            issTrailGeo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            issTrailGeo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            issTrailLine.geometry.attributes.position.needsUpdate = true;
            issTrailLine.geometry.attributes.color.needsUpdate = true;
            issTrailLine.geometry.setDrawRange(0, issTrailPositions.length);

            astronautMarkers.forEach(astronaut => {
                const offset = new THREE.Vector3(
                    (Math.random() - 0.5) * 0.01,
                    (Math.random() - 0.5) * 0.01,
                    (Math.random() - 0.5) * 0.01
                );
                astronaut.position.copy(issMarker.position).add(offset);
            });
        };

        function createStars() {
            const starGeometry = new THREE.BufferGeometry();
            const starVertices = [];
            const starColors = [];
            const numStars = 10000;

            for (let i = 0; i < numStars; i++) {
                const x = THREE.MathUtils.randFloatSpread(400);
                const y = THREE.MathUtils.randFloatSpread(400);
                const z = THREE.MathUtils.randFloatSpread(400);
                starVertices.push(x, y, z);

                const hue = Math.random();
                const saturation = Math.random() * 0.3 + 0.7;
                const lightness = Math.random() * 0.2 + 0.8;
                const starColor = new THREE.Color().setHSL(hue, saturation, lightness);
                starColors.push(starColor.r, starColor.g, starColor.b);
            }
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            starGeometry.setAttribute('color', new THREE.Float32BufferAttribute(starColors, 3));

            const starMaterial = new THREE.PointsMaterial({
                size: 0.2,
                vertexColors: true,
                transparent: true,
                opacity: 0.9,
                blending: THREE.AdditiveBlending
            });

            stars = new THREE.Points(starGeometry, starMaterial);
            scene.add(stars);
        };

        function createSatelliteModel(mainColor) {
            const satelliteGroup = new THREE.Group();

            let bodyGeometry;
            if (Math.random() > 0.5) {
                bodyGeometry = new THREE.BoxGeometry(0.02, 0.02, 0.04);
            } else {
                bodyGeometry = new THREE.CylinderGeometry(0.015, 0.015, 0.04, 16);
            }
            const bodyMaterial = new THREE.MeshStandardMaterial({
                color: mainColor,
                roughness: 0.7,
                metalness: 0.2,
                emissive: 0x010101
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            satelliteGroup.add(body);

            const panelGeometry = new THREE.BoxGeometry(0.06, 0.003, 0.03);
            const panelMaterial = new THREE.MeshStandardMaterial({
                color: 0x1a1a1a,
                metalness: 0.9,
                roughness: 0.3,
                side: THREE.DoubleSide
            });

            const panel1 = new THREE.Mesh(panelGeometry, panelMaterial);
            panel1.position.x = -0.04;
            panel1.rotation.y = Math.PI / 2;
            satelliteGroup.add(panel1);

            const panel2 = new THREE.Mesh(panelGeometry, panelMaterial);
            panel2.position.x = 0.04;
            panel2.rotation.y = Math.PI / 2;
            satelliteGroup.add(panel2);

            const antennaGeometry = new THREE.CylinderGeometry(0.003, 0.003, 0.03, 8);
            const antennaMaterial = new THREE.MeshStandardMaterial({ color: 0x888888, metalness: 0.8, roughness: 0.4 });
            const antenna = new THREE.Mesh(antennaGeometry, antennaMaterial);
            antenna.position.y = 0.025;
            satelliteGroup.add(antenna);

            const thrusterGeometry = new THREE.CylinderGeometry(0.004, 0.004, 0.01, 6);
            const thrusterMaterial = new THREE.MeshStandardMaterial({ color: 0x555555 });
            const thruster1 = new THREE.Mesh(thrusterGeometry, thrusterMaterial);
            thruster1.position.z = 0.025;
            thruster1.rotation.x = Math.PI / 2;
            satelliteGroup.add(thruster1);
            const thruster2 = new THREE.Mesh(thrusterGeometry, thrusterMaterial);
            thruster2.position.z = -0.025;
            thruster2.rotation.x = Math.PI / 2;
            satelliteGroup.add(thruster2);


            return satelliteGroup;
        };

        function createGenericSatellites() {
            const earthRadius = 1;
            const satelliteColors = [
                0xAAAAAA, 0xFF0000, 0x00FF00, 0x0000FF, 0xFFFF00, 0xFF00FF, 0x00FFFF
            ];

            for (let i = 0; i < NUM_GENERIC_SATELLITES; i++) {
                const altitudeOffset = Math.random() * (SATELLITE_ORBIT_MAX_ALT - SATELLITE_ORBIT_MIN_ALT) + SATELLITE_ORBIT_MIN_ALT;
                const orbitRadius = earthRadius + altitudeOffset;

                const mainColor = satelliteColors[Math.floor(Math.random() * satelliteColors.length)];
                const satelliteGroup = createSatelliteModel(mainColor);

                const inclination = THREE.MathUtils.degToRad(Math.random() * 180);
                const ascendingNode = THREE.MathUtils.degToRad(Math.random() * 360);

                const orbitalPlaneGroup = new THREE.Group();
                orbitalPlaneGroup.rotation.x = inclination;
                orbitalPlaneGroup.rotation.y = ascendingNode;

                satelliteGroup.position.x = orbitRadius;
                satelliteGroup.position.y = 0;
                satelliteGroup.position.z = 0;

                orbitalPlaneGroup.add(satelliteGroup);
                scene.add(orbitalPlaneGroup);

                orbitalPlaneGroup.name = `Generic Satellite Orbital Plane ${i + 1}`;
                orbitalPlaneGroup.userData = {
                    type: 'Generic Satellite',
                    id: `SAT-${i + 1}`,
                    orbitRadius: orbitRadius.toFixed(2),
                    orbitalSpeed: (Math.random() * 0.0005 + 0.0001) * (Math.random() < 0.5 ? 1 : -1),
                    initialAngle: Math.random() * Math.PI * 2,
                    yOffset: (Math.random() - 0.5) * (SATELLITE_ORBIT_MAX_ALT - SATELLITE_ORBIT_MIN_ALT) * 0.5,
                    originalMaterialColor: mainColor,
                    actualSatelliteMesh: satelliteGroup
                };

                genericSatellites.push(orbitalPlaneGroup);
            }
        };

        function createAstronautMarkers() {
            astronautMarkers.forEach(marker => scene.remove(marker));
            astronautMarkers = [];

            const astronautGeometry = new THREE.SphereGeometry(0.01, 8, 8);
            const astronautMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending });

            const baseRadius = 1 + 0.08;
            const spreadRadius = 0.03;

            astronautsNames.forEach((name, index) => {
                const phi = Math.acos(2 * Math.random() - 1);
                const theta = Math.random() * 2 * Math.PI;

                const offsetVec = new THREE.Vector3(
                    spreadRadius * Math.sin(phi) * Math.cos(theta),
                    spreadRadius * Math.cos(phi),
                    spreadRadius * Math.sin(phi) * Math.sin(theta)
                );

                const astronaut = new THREE.Mesh(astronautGeometry, astronautMaterial.clone());
                astronaut.position.copy(issMarker.position).add(offsetVec);
                astronaut.name = `Astronaut: ${name}`;
                astronaut.userData = {
                    type: 'Astronaut',
                    name: name,
                    craft: 'ISS',
                    originalColor: astronaut.material.color.clone()
                };
                scene.add(astronaut);
                astronautMarkers.push(astronaut);
            });
        };

        function createStars() {
            const starGeometry = new THREE.BufferGeometry();
            const starVertices = [];
            const starColors = [];
            const numStars = 10000;

            for (let i = 0; i < numStars; i++) {
                const x = THREE.MathUtils.randFloatSpread(400);
                const y = THREE.MathUtils.randFloatSpread(400);
                const z = THREE.MathUtils.randFloatSpread(400);
                starVertices.push(x, y, z);

                const hue = Math.random();
                const saturation = Math.random() * 0.3 + 0.7;
                const lightness = Math.random() * 0.2 + 0.8;
                const starColor = new THREE.Color().setHSL(hue, saturation, lightness);
                starColors.push(starColor.r, starColor.g, starColor.b);
            }
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            starGeometry.setAttribute('color', new THREE.Float32BufferAttribute(starColors, 3));

            const starMaterial = new THREE.PointsMaterial({
                size: 0.2,
                vertexColors: true,
                transparent: true,
                opacity: 0.9,
                blending: THREE.AdditiveBlending
            });

            stars = new THREE.Points(starGeometry, starMaterial);
            scene.add(stars);
        };

        function createAsteroidBelt() {
            const asteroidGeometry = new THREE.SphereGeometry(0.01, 8, 8);
            const asteroidMaterial = new THREE.MeshStandardMaterial({ color: 0x886644, roughness: 0.8, metalness: 0.1 });
            asteroidBelt = new THREE.Group();

            for (let i = 0; i < NUM_ASTEROIDS; i++) {
                const asteroid = new THREE.Mesh(asteroidGeometry, asteroidMaterial);
                
                const distance = THREE.MathUtils.randFloat(ASTEROID_BELT_MIN_RADIUS, ASTEROID_BELT_MAX_RADIUS);
                const angle = Math.random() * Math.PI * 2;
                const inclination = THREE.MathUtils.degToRad(THREE.MathUtils.randFloatSpread(10));

                asteroid.position.x = distance * Math.cos(angle);
                asteroid.position.y = distance * Math.sin(angle) * Math.sin(inclination);
                asteroid.position.z = distance * Math.sin(angle) * Math.cos(inclination);

                asteroid.rotation.x = Math.random() * Math.PI;
                asteroid.rotation.y = Math.random() * Math.PI;
                asteroid.rotation.z = Math.random() * Math.PI;

                asteroid.userData = { type: 'Asteroid', id: `AST-${i + 1}`, description: 'A small rocky body orbiting the Sun.' };
                asteroidBelt.add(asteroid);
            }
            scene.add(asteroidBelt);
            asteroidBelt.visible = true;
        };

        function createOrbitPaths() {
            const material = new THREE.LineBasicMaterial({ color: 0x333333, transparent: true, opacity: 0.3 });
            const segments = 128;

            const earthOrbitRadius = 1;
            const earthPoints = [];
            for (let i = 0; i <= segments; i++) {
                const angle = (i / segments) * Math.PI * 2;
                earthPoints.push(new THREE.Vector3(earthOrbitRadius * Math.cos(angle), 0, earthOrbitRadius * Math.sin(angle)));
            }
            const earthOrbitGeometry = new THREE.BufferGeometry().setFromPoints(earthPoints);
            const earthOrbitLine = new THREE.Line(earthOrbitGeometry, material);
            earthOrbitLine.name = "EarthOrbitPath";
            scene.add(earthOrbitLine);
            orbitPaths.push(earthOrbitLine);
            orbitPaths.forEach(path => path.visible = true);
        };

        function onDocumentMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
        };

        function checkHoveredObjects() {
            raycaster.setFromCamera(mouse, camera);
            const interactableObjects = [issMarker, ...genericSatellites, ...astronautMarkers, ...(asteroidBelt ? asteroidBelt.children : [])];
            const intersects = raycaster.intersectObjects(interactableObjects, true);

            if (intersects.length > 0) {
                let foundObject = intersects[0].object;
                while (foundObject && !foundObject.userData.type && foundObject.parent) {
                    foundObject = foundObject.parent;
                }

                if (foundObject && foundObject.userData.type) {
                    let meshToHighlight = foundObject;
                    if (foundObject.userData.type === 'Generic Satellite' && foundObject.children[0]) {
                        meshToHighlight = foundObject.children[0];
                    } else if (foundObject.userData.type === 'Asteroid') {
                        meshToHighlight = foundObject;
                    }


                    if (currentlyHoveredObject !== meshToHighlight) {
                        if (currentlyHoveredObject) {
                            restoreOriginalColor(currentlyHoveredObject);
                        }
                        applyHighlightColor(meshToHighlight);
                        currentlyHoveredObject = meshToHighlight;
                        webglContainer.classList.add('hovering');
                    }
                } else {
                    if (currentlyHoveredObject) {
                        restoreOriginalColor(currentlyHoveredObject);
                        currentlyHoveredObject = null;
                        webglContainer.classList.remove('hovering');
                    }
                }
            } else {
                if (currentlyHoveredObject) {
                    restoreOriginalColor(currentlyHoveredObject);
                    currentlyHoveredObject = null;
                    webglContainer.classList.remove('hovering');
                }
            }
        };

        function applyHighlightColor(mesh) {
            if (mesh && mesh.material && mesh.material.color) {
                if (!mesh.userData.originalColor) {
                    mesh.userData.originalColor = mesh.material.color.clone();
                }
                mesh.material.color.set(0x00ffaa);
            }
        };

        function restoreOriginalColor(mesh) {
            if (mesh && mesh.material && mesh.userData.originalColor) {
                mesh.material.color.copy(mesh.userData.originalColor);
                delete mesh.userData.originalColor;
            }
        };

        function onDocumentClick(event) {
            raycaster.setFromCamera(mouse, camera);
            const interactableObjects = [issMarker, ...genericSatellites, ...astronautMarkers, ...(asteroidBelt ? asteroidBelt.children : [])];
            const intersects = raycaster.intersectObjects(interactableObjects, true);

            if (intersects.length > 0) {
                let foundObject = intersects[0].object;
                while (foundObject && !foundObject.userData.type && foundObject.parent) {
                    foundObject = foundObject.parent;
                }

                if (foundObject && foundObject.userData.type) {
                    clicked3DObject = foundObject;
                    let infoTitle = "Object Info";
                    let infoContent = "No additional information available.";

                    const originalScale = clicked3DObject.scale.clone();
                    clicked3DObject.scale.set(originalScale.x * 1.2, originalScale.y * 1.2, originalScale.z * 1.2);
                    new TWEEN.Tween(clicked3DObject.scale)
                        .to(originalScale, 200)
                        .easing(TWEEN.Easing.Quadratic.Out)
                        .start();

                    if (clicked3DObject.name === "ISS") {
                        infoTitle = "International Space Station";
                        infoContent = `Status: In Orbit<br>Current Location: Lat ${issLatitude.toFixed(2)}, Lon ${issLongitude.toFixed(2)}<br>Crew On Board: ${astronauts} astronauts`;
                    } else if (clicked3DObject.userData.type === 'Astronaut') {
                        infoTitle = `Astronaut: ${clicked3DObject.userData.name}`;
                        infoContent = `Craft: ${clicked3DObject.userData.craft}<br>Currently in the vicinity of the ISS.`;
                    } else if (clicked3DObject.userData.type === 'Generic Satellite') {
                        infoTitle = `Satellite: ${clicked3DObject.userData.id}`;
                        infoContent = `Type: ${clicked3DObject.userData.type}<br>Approx. Orbit Radius: ${clicked3DObject.userData.orbitRadius} Earth Radii<br>Orbital Speed: ${(clicked3DObject.userData.orbitalSpeed * 1000).toFixed(3)} rad/sec<br>(Generic orbital path and design)`;
                    } else if (clicked3DObject.userData.type === 'Asteroid') {
                        infoTitle = `Asteroid: ${clicked3DObject.userData.id}`;
                        infoContent = `Type: ${clicked3DObject.userData.type}<br>Description: ${clicked3DObject.userData.description}<br>(Randomly generated for visual effect)`;
                    }

                    showObjectInfo(infoTitle, infoContent);
                } else {
                    hideObjectInfo();
                }
            } else {
                hideObjectInfo();
            }
        };

        function showObjectInfo(title, content) {
            modalTitle.innerText = title;
            modalContent.innerHTML = content;

            objectInfoModal.style.display = 'block';
            objectInfoModal.classList.add('show');
        };


        function hideObjectInfo() {
            if (objectInfoModal.classList.contains('show')) {
                objectInfoModal.classList.remove('show');
                objectInfoModal.addEventListener('transitionend', function handler() {
                    objectInfoModal.style.display = 'none';
                    objectInfoModal.removeEventListener('transitionend', handler);
                }, { once: true });
            } else {
                objectInfoModal.style.display = 'none';
            }
        };

        function updateDataOverlay() {
            apodTitleSpan.innerText = apodTitle;
            issCoordsSpan.innerText = `Lat: ${issLatitude.toFixed(2)}, Lon: ${issLongitude.toFixed(2)}`;
            astronautCountSpan.innerText = astronauts;
        };

        function showErrorMessage(message) {
            errorMessageDiv.innerText = message;
            errorMessageDiv.style.display = 'block';
            if (errorMessageTimeout) {
                clearTimeout(errorMessageTimeout);
            }
            errorMessageTimeout = setTimeout(() => {
                errorMessageDiv.style.display = 'none';
            }, ERROR_DISPLAY_DURATION);
        };

        function hideIntroScreen() {
            introScreen.classList.add('hidden');
        };

        function toggleAutoRotate() {
            controls.autoRotate = !controls.autoRotate;
            toggleRotateButton.innerText = controls.autoRotate ? 'Disable Auto-Rotate' : 'Enable Auto-Rotate';
        };

        function recenterCamera() {
            camera.position.set(0, 0, 2);
            controls.target.set(0, 0, 0);
            controls.update();
            controls.autoRotate = true;
            toggleRotateButton.innerText = 'Disable Auto-Rotate';
        };

        function toggleSatellitesVisibility() {
            const areSatellitesVisible = genericSatellites.length > 0 && genericSatellites[0].visible;
            genericSatellites.forEach(satellite => {
                satellite.visible = !areSatellitesVisible;
            });
            toggleSatellitesButton.innerText = areSatellitesVisible ? 'Show Satellites' : 'Hide Satellites';
        };

        function toggleAsteroidBeltVisibility() {
            if (asteroidBelt) {
                asteroidBelt.visible = !asteroidBelt.visible;
                toggleAsteroidBeltButton.innerText = asteroidBelt.visible ? 'Hide Asteroid Belt' : 'Show Asteroid Belt';
            } else {
                showErrorMessage("Asteroid belt not initialized yet.");
            }
        };

        function toggleOrbitPathsVisibility() {
            const arePathsVisible = orbitPaths.length > 0 && orbitPaths[0].visible;
            orbitPaths.forEach(path => {
                path.visible = !arePathsVisible;
            });
            toggleOrbitPathsButton.innerText = arePathsVisible ? 'Hide Orbit Paths' : 'Show Orbit Paths';
        };

        function focusCameraOnObject(object) {
            hideObjectInfo();

            const targetPosition = new THREE.Vector3();
            object.getWorldPosition(targetPosition);

            let distance = 0.5;
            if (object.name === "ISS") {
                distance = 0.3;
            } else if (object.userData.type === 'Generic Satellite') {
                distance = 0.15;
            } else if (object.userData.type === 'Astronaut') {
                distance = 0.05;
            } else if (object.userData.type === 'Asteroid') {
                distance = 0.08;
            }

            const offset = new THREE.Vector3(0.5, 0.5, 1.5).normalize().multiplyScalar(distance);
            const newCameraPosition = targetPosition.clone().add(offset);

            controls.autoRotate = false;
            toggleRotateButton.innerText = 'Enable Auto-Rotate';

            new TWEEN.Tween(camera.position)
                .to({ x: newCameraPosition.x, y: newCameraPosition.y, z: newCameraPosition.z }, 1000)
                .easing(TWEEN.Easing.Quadratic.InOut)
                .start();

            new TWEEN.Tween(controls.target)
                .to({ x: targetPosition.x, y: targetPosition.y, z: targetPosition.z }, 1000)
                .easing(TWEEN.Easing.Quadratic.InOut)
                .onUpdate(() => controls.update())
                .start();
        };

        function askAIAboutObject(object) {
            hideObjectInfo();
            toggleChatMinimize();
            chatInput.focus();

            let objectName = object.userData.name || object.name || "this object";
            let objectType = object.userData.type || "celestial object";
            
            let questionPrompt;
            if (object.name === 'ISS') {
                questionPrompt = `Give me 1-3 concise and helpful facts about the International Space Station (ISS) mission.`;
            } else if (object.userData.type === 'Generic Satellite') {
                questionPrompt = `Give me 1-3 concise and helpful facts about the common purposes of artificial Earth-orbiting satellites.`;
            } else if (object.userData.type === 'Astronaut') {
                 questionPrompt = `Give me 1-3 concise and helpful facts about what astronauts experience or do in space.`;
            } else if (object.name === 'Earth' && object.userData.type === 'Planet') {
                 questionPrompt = `Give me 1-3 concise fascinating and helpful facts about Earth.`;
            } else if (object.userData.type === 'Asteroid') {
                 questionPrompt = `Give me 1-3 concise and helpful facts about asteroids.`;
            } else {
                 questionPrompt = `Give me 1-3 concise and helpful facts about ${objectName}.`;
            }

            chatInput.value = questionPrompt;
            sendChatMessage();
        };

        function toggleChatMinimize() {
            chatAssistantContainer.classList.toggle('minimized');
            chatMinimizeButton.innerText = chatAssistantContainer.classList.contains('minimized') ? '+' : '_';
        };

        function addChatMessage(message, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', sender);
            messageElement.innerText = message;
            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        function updateChatWindow() {
            chatWindow.innerHTML = '';
            chatHistory.forEach(msg => {
                addChatMessage(msg.parts[0].text, msg.role === 'user' ? 'user' : 'ai');
            });
        };

        async function sendChatMessage() {
            const userMessage = chatInput.value.trim();
            if (userMessage === '') return;

            addChatMessage(userMessage, 'user');
            chatInput.value = '';

            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

            aiTypingIndicator.style.display = 'block';
            chatInput.disabled = true;
            chatSendButton.disabled = true;
            isAITyping = true;

            try {
                const payload = { contents: chatHistory };
                const apiKey = geminiApiKey;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Gemini API Error Response:', response.status, errorText);
                    if (response.status === 401) {
                        addChatMessage("AI: Error 401 Unauthorized. This often means the API key is not set up correctly in your environment. Please check console for details.", 'ai');
                        showErrorMessage("AI Unauthorized: Check environment API key setup.");
                    } else if (response.status === 400) {
                         addChatMessage("AI: Error 400 Bad Request. The prompt might be too complex or malformed for the AI. Please try rephrasing your question.", 'ai');
                         showErrorMessage("AI Bad Request: Review prompt content.");
                    } else {
                        addChatMessage(`AI: Network error: ${response.status}. Please try again.`, 'ai');
                        showErrorMessage(`AI Network Error: Status ${response.status}.`);
                    }
                    throw new Error(`Gemini API HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponseText = result.candidates[0].content.parts[0].text;
                    addChatMessage("AI: " + aiResponseText, 'ai');
                    chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });
                } else {
                    addChatMessage("AI: I couldn't generate a response. The AI might be blocked or the response was empty. Please try asking something else.", 'ai');
                    console.warn('Gemini API response structure unexpected:', result);
                    showErrorMessage("AI Response Empty: Check console for details.");
                }
            } catch (error) {
                console.error('Error fetching AI response:', error);
                if (!isAITyping) {
                    addChatMessage("AI: Sorry, I'm having trouble connecting right now. Please try again later.", 'ai');
                }
                showErrorMessage(`AI Assistant Error: ${error.message}.`);
            } finally {
                aiTypingIndicator.style.display = 'none';
                chatInput.disabled = false;
                chatSendButton.disabled = false;
                isAITyping = false;
                chatInput.focus();
            }
        };

        async function fetchAPOD() {
            try {
                const response = await fetch(`https://api.nasa.gov/planetary/apod?api_key=${NASA_API_KEY}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                apodTitle = data.title || "Untitled APOD";

                let textureToLoadUrl = 'https://unpkg.com/three-globe@2.27.6/example/img/earth-blue-marble.jpg';
                if (data.media_type === 'image') {
                } else if (data.media_type === 'video') {
                    console.warn('APOD is a video. Not using as Earth texture.');
                    apodTitle += " (Video)";
                } else {
                    console.warn('Unknown APOD media type:', data.media_type);
                }

                new THREE.TextureLoader().load(
                    textureToLoadUrl,
                    (texture) => {
                        if (earth) {
                            earth.material.map = texture;
                            earth.material.needsUpdate = true;
                            apodImage = texture;
                            console.log('Earth texture loaded successfully.');
                        }
                    },
                    undefined,
                    (err) => {
                        console.error('Failed to load Earth texture (APOD or default):', err);
                        if (earth) {
                            earth.material.map = null;
                            earth.material.color.set(0x0000FF);
                            earth.material.needsUpdate = true;
                        }
                        showErrorMessage('Failed to load Earth texture. Using default color.');
                    }
                );
            } catch (error) {
                console.error('Error fetching APOD data:', error);
                apodTitle = "Error fetching APOD";
                new THREE.TextureLoader().load(
                    'https://unpkg.com/three-globe@2.27.6/example/img/earth-blue-marble.jpg',
                    (texture) => {
                        if (earth) {
                            earth.material.map = texture;
                            earth.material.needsUpdate = true;
                        }
                    },
                    undefined,
                    (err) => {
                        console.error('Failed to load fallback Earth texture:', err);
                        if (earth) {
                            earth.material.map = null;
                            earth.material.color.set(0x0000FF);
                            earth.material.needsUpdate = true;
                        }
                    }
                );
                showErrorMessage('Failed to fetch APOD data. Using default Earth texture.');
            }
        };

        async function fetchISSLocation() {
            try {
                const response = await fetch('https://corsproxy.io/?http://api.open-notify.org/iss-now.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data && data.iss_position) {
                    issLatitude = parseFloat(data.iss_position.latitude);
                    issLongitude = parseFloat(data.iss_position.longitude);
                } else {
                    console.warn('ISS position data not found in response:', data);
                    showErrorMessage('ISS location data missing.');
                }
            } catch (error) {
                console.error('Error fetching ISS location:', error);
                showErrorMessage(`Failed to fetch ISS location: ${error.message}.`);
            }
        };

        async function fetchPeopleInSpace() {
            try {
                const response = await fetch('https://corsproxy.io/?http://api.open-notify.org/astros.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data && data.number !== undefined && data.people) {
                    astronauts = parseInt(data.number);
                    astronautsNames = data.people.map(p => p.name);

                    createAstronautMarkers();

                } else {
                    console.warn('Astronauts data not found in response:', data);
                    showErrorMessage('Astronauts data missing.');
                }
            } catch (error) {
                console.error('Error fetching people in space:', error);
                showErrorMessage(`Failed to fetch astronauts count: ${error.message}.`);
            }
        };
    </script>
</body>
</html>
